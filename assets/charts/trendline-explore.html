<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="shortcut icon" href="https://carto.com/favicon.ico" />
  <style>
    html,
    body {
      height: 100%;
      padding: 0;
      margin: 0;

      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body class="data-page">

  <script src="https://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    const sql = new cartodb.SQL({ user: 'joinzoe', api_key: 'N6sTD5Jriyd5fxO8Y19Dzw' });
    const primaryColor = '#0165B5'
    var ctx = document.getElementById('overTime');
    var chart;
    var dataset;

    window.covid = {
      updateTimeWindow: function(event) {
        const { type } = event.payload;
        switch (type) {
          case 'WEEK':
            showLastXDays(7);
            return;
          case 'MONTH':
            showLastXDays(31);
            return;
          case 'ALL':
            showAll();
            return;
          default:
            return;
        }
      },
      emit: function(event, data) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ 
          type: event, data
        }));
      }
    };

    sql.execute("SELECT * FROM uk_active_cases")
      .done(function (data) {
        var corrected_covid_positive = [];
        var covid_dates = [];

        const mapped = data.rows.map(item => ({
          t: moment(item.date),
          y: Math.round(item.corrected_covid_positive)
        }))

        setupTradingView(mapped)
      })
      .error(function (errors) {
        console.log("errors:" + errors);
      });

    function randomNumber(min, max) {
      return Math.random() * (max - min) + min;
    }

    function showLastXDays(days) {
      chart.timeScale().setVisibleRange({
        from: (moment().subtract(days, 'days').toDate()).getTime() / 1000,
        to: (moment().toDate()).getTime() / 1000,
      });
    }

    function showAll() {
      chart.timeScale().setVisibleRange({
        from: dataset[0].t.toDate().getTime() / 1000,
        to: (moment().toDate()).getTime() / 1000,
      });
    }

    const setupTradingView = function (data) {
      dataset = data;

      chart = LightweightCharts.createChart(document.body, {
        rightPriceScale: {
          visible: false,
        },
        leftPriceScale: {
          visible: true,
          borderColor: '#AAACAD',
        },
        layout: {
          backgroundColor: '#ffffff',
          textColor: '#AAACAD',
        },
        grid: {
          horzLines: {
            color: '#F0F3FA',
          },
          vertLines: {
            visible: false,
          },
        },
        timeScale: {
          borderColor: 'rgba(197, 203, 206, 1)',
          // tickMarkFormatter: (time, tickMarkType, locale) => {
          //   console.log(time, tickMarkType, locale);
          //   const year = LightweightCharts.isBusinessDay(time) ? time.year : new Date(time * 1000).getUTCFullYear();
          //   return String(year);
          // },
        },
        handleScroll: {
          vertTouchDrag: false,
        },
      });

      const timeseries = data.map(item => ({
        time: {
          year: item.t.format("YYYY"),
          month: item.t.format("MM"),
          day: item.t.format("DD")
        },
        value: item.y
      }))

      console.log(timeseries)

      chart.addLineSeries({
        color: primaryColor,
        lineWidth: 2,
        priceScaleId: 'left'
      }).setData(timeseries);
      
      showLastXDays(7)

    }

  </script>
</body>

</html>
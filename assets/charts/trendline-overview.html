<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="shortcut icon" href="https://carto.com/favicon.ico" />
  <style>
    html,
    body {
      height: 100%;
      padding: 0;
      margin: 0;
    }
  </style>
</head>

<body class="data-page">

  <canvas id="overTime" class="chartjs-render-monitor"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  <script src="https://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>
  <script>
    const sql = new cartodb.SQL({ user: 'joinzoe', api_key: 'N6sTD5Jriyd5fxO8Y19Dzw' });
    const primaryColor = '#0165B5'
    var ctx = document.getElementById('overTime');

    window.timeWidow = 'WEEK'

    const setupChart = function(labels, data) { 
      var myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Predicted # of cases',
              data: data,
              borderWidth: 2,
              borderColor: primaryColor,
              pointBorderColor: primaryColor,
              pointBackgroundColor: primaryColor,
              pointHoverBackgroundColor: primaryColor,
              pointHoverBorderColor: primaryColor,
              pointBorderWidth: 2,
              pointHoverRadius: 2,
              pointHoverBorderWidth: 1,
              pointRadius: 0.1,
              fill: false,
            }]
          },
          options: {
            maintainAspectRatio: false,
            legend: {
              display: false
            },
            tooltips: {
              callbacks: {
                label: function (tooltipItems, data) {
                  return 'Predicted # of cases: ' + data.datasets[0].data[tooltipItems.index].toLocaleString();
                }
              }
            },
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true,
                  max: 250000,
                  min: 0,
                  stepSize: 250000 / 5,
                  callback: function (value, index, values) {
                    return value.toLocaleString();
                  }
                },
                gridLines: {
                  color: "rgba(0, 0, 0, 0.05)",
                }
              }],
              xAxes: [{
                ticks: {
                  beginAtZero: true,
                  autoSkip: true,
                  maxTicksLimit: 6
                },
                gridLines: {
                  color: "rgba(0, 0, 0, 0.05)",
                }
              }]
            },
            label: {
              fontFamily: 'Sofia pro'
            }
          }
        });
    }
    sql.execute("SELECT * FROM uk_active_cases")
      .done(function (data) {
        var corrected_covid_positive = [];
        var covid_dates = [];
        $.each(data.rows, function (key, value) {
          corrected_covid_positive.push(Math.round(value.corrected_covid_positive));
          covid_dates.push(moment(value.date).format("D MMM"));
        });

        console.log(covid_dates)
        console.log(covid_dates)

        setupChart(covid_dates, corrected_covid_positive)
      })
      .error(function (errors) {
        console.log("errors:" + errors);
      });
  </script>
</body>

</html>